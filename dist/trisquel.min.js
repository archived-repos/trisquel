!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.trisquel=e()}(this,function(){"use strict";function t(t,e,n){for(var r=0,i=t.length;r<i;r++)e=t[r](e,n);return e}function e(t,e){return e.map(function(e){var n,r,i=e.match(/([^:]+):(.*)/);return i?(n=i[1].trim(),r=[i[2]]):(n=e.trim(),r=[]),function(e,i){if(!t[n])throw new Error("filter '"+n+"' is not defined");return t[n].apply(i,[e].concat(r.map(function(t){return i.eval(t)})))}})}function n(t){for(var e=t.split(/ *\| */),n=[],r=e.shift();void 0!==r;)""===r?n[n.length-1]+="||"+e.shift():n.push(r),r=e.shift();return{expression:n.shift().trim(),filters:n}}function r(r,i){var o=n(r),c=new Function("scope","try { with(scope) { return ("+o.expression+"); }; } catch(err) { return ''; }"),s=i?e(i,o.filters):[];return function(e,n){return t(s,n?n.call(e,o.expression,e):c(e),e)}}function i(t){return this instanceof i?void(t instanceof Object&&this.extend(t)):new i(t)}function o(t,e,n,r,c){for(var s=e.shift(),f={$$content:[],$$otherwise:[]},u="$$content",h=t.cmds,a=function(e,n,r){return function(o){return e[n].call(t,o instanceof i?o:new i(o),r)}},l=function(e){return h[n].call(t,e instanceof i?e:new i(e),r,function(t){return f.$$content.map(function(e){return e instanceof Function?e(t):e}).join("")},function(t){return f.$$otherwise.map(function(e){return e instanceof Function?e(t):e}).join("")})};void 0!==s;){if("string"==typeof s)f[u].push(s);else if("string"==typeof s.cmd)if(s.cmd){if(!h[s.cmd])throw new Error("cmd '"+s.cmd+"' is not defined");h[s.cmd].$no_content?f[u].push(a(h,s.cmd,s.expression)):f[u].push(o(t,e,s.cmd,s.expression,!0))}else f[u].push(a(h,s.cmd,s.expression));else{if(":"!==s.expression&&"else"!==s.expression){if("/"===s.expression){if(!c)throw new Error("can not close root level");return l}throw new Error("'"+s.expression+"' is not a valid no-cmd expression")}u="$$otherwise"}s=e.shift()}if(c)throw new Error("cmd '"+n+"' not closed propertly");return l}function c(t){if("string"!=typeof t)throw new TypeError("template should be a string");var e=0,n=t.split(h),r=[],i=this.cmds;return r[e++]=n.shift(),t.replace(a,function(t,o,c,s){if(c=s||c,o&&!i[o])throw new Error("cmd '"+o+"' is not defined");var f=n.shift();if(/\{/.test(c)){var u=c.split("{").length-c.split("}").length;if(u<0)throw new Error("curly brackets mismatch");if(u>0){for(var h=f.split("}");u>0;){if(h.length-1<u)throw new Error("expression curly brackets mismatch");c+=h.splice(0,u).join("}")+"}",u=c.split("{").length-c.split("}").length}f=h.join("}")}}r[e++]={cmd:o,expression:c},r[e++]=f}),o(this,r,"root")}function s(t,e){return e?c.call(this,t)(e):c.call(this,t)}function f(t,e){return s.call(f,t,e)}function u(t){t||void 0===t?(this.cmds=Object.create(f.cmds),this.filters=Object.create(f.filters),this.cache=Object.create(f.cache)):(this.cmds=Object.create(p),this.filters={},this.cache={})}i.prototype.new=function(t){var e=Object.create(this);return t instanceof Object&&e.extend(t),e},i.prototype.extend=function(t){for(var e in t)this[e]=t[e];return this},i.prototype.eval=function(t){return r(t)(this)};var h=/\$\w*{[^}]*}|{\/}|{:}|{else}/,a=/\$(\w*){([^}]*)}|{(\/|:|else)}/g,l=/([^,]+)(\s*,\s*([\S]+))? in (\S+)/,p={"":function(t,e){return this.eval(e,t)},root:function(t,e,n,r){return n(t)},if:function(t,e,n,r){return this.eval(e,t)?n(t):r(t)},each:function(t,e,n,r){var i,o,c,s,f=l.exec(e.trim());if(!f)throw new Error("each expression is not correct");var u="",h=f[1],a=this.eval(f[4],t),p=f[3]||(a instanceof Array?"$index":"$key");if(a instanceof Array)for(o=0,c=a.length;o<c;o++)s=t.new(),s[p]=o,s[h]=a[o],u+=n(s);else for(i in a)s=t.new(),s[p]=i,s[h]=a[i],u+=n(s);return u}};f.cmds=Object.create(p),f.filters={},f.cache={},f.scope=i,f.Scope=i,f.Trisquel=u;var d={compile:s,eval:function(t,e,n){return e?r(t,this.filters)(e,n):r(t,this.filters)},filter:function(t,e){return void 0===e?this.filters[t]:void(this.filters[t]=e)},cmd:function(t,e,n){e.$no_content=n,this.cmds[t]=e},get:function(t){return this.cache[t]},put:function(t,e){return this.cache[t]=this.compile(e),this.cache[t]},clear:function(){for(var t in this.cache)delete this.cache[t]}};for(var m in d)f[m]=d[m],u.prototype[m]=d[m];return f.cmd("include",function(t,e){var n=this.get(e.trim());if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),f.cmd("includeEval",function(t,e){var n=this.get(this.eval(e,t));if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),f});