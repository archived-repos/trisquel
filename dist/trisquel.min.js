!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.trisquel=t()}(this,function(){"use strict";function n(t,e){return void 0!==e&&n.put(t,e),n.get(t)}function t(n){for(var t=n.split("|"),e=[],r=t.shift();void 0!==r;)""===r?e[e.length-1]+="||"+t.shift():e.push(r),r=t.shift();return{expression:e.shift(),filters:e}}function e(e){var r=t(e),o=new Function("scope","try { with(scope) { return ("+r.expression+"); }; } catch(err) { return ''; }"),i=n.map(r.filters);return function(n){for(var t=o(n),e=0,r=i.length;e<r;e++)t=i[e](t,n);return t}}function r(n,t){return function(e){return l[n](e,t)}}function o(n,t,e,i){for(var u=n.shift(),f={$$content:[],$$otherwise:[]},s="$$content",c=function(n){return l[t](n,e,function(n){return f.$$content.map(function(t){return t instanceof Function?t(n):t}).join("")},function(n){return f.$$otherwise.map(function(t){return t instanceof Function?t(n):t}).join("")})};void 0!==u;){if("string"==typeof u)f[s].push(u);else if("string"==typeof u.cmd)if(u.cmd){if(!l[u.cmd])throw new Error("cmd '"+u.cmd+"' is not defined");l[u.cmd].$noContent?f[s].push(r(u.cmd,u.expression)):f[s].push(o(n,u.cmd,u.expression,!0))}else f[s].push(r(u.cmd,u.expression));else{if(":"!==u.expression&&"else"!==u.expression){if("/"===u.expression){if(!i)throw new Error("can not close root level");return c}throw new Error("'"+u.expression+"' is not a valid no-cmd expression")}s="$$otherwise"}u=n.shift()}if(i)throw new Error("cmd '"+t+"' not closed propertly");return c}function i(n){if("string"!=typeof n)throw new Error("template should be a string");var t=0,e=n.split(p),r=[];return r[t++]=e.shift(),n.replace(h,function(n,o,i,u){if(i=u||i,o&&!l[o])throw new Error("cmd '"+o+"' is not defined");var f=e.shift();if(/\{/.test(i)){var s=i.split("{").length-i.split("}").length;if(s<0)throw new Error("curly brackets mismatch");if(s>0){for(var c=f.split("}");s>0;){if(c.length-1<s)throw new Error("expression curly brackets mismatch");i+=c.splice(0,s).join("}")+"}",s=i.split("{").length-i.split("}").length}f=c.join("}")}}r[t++]={cmd:o,expression:i},r[t++]=f}),o(r,"root")}function u(n){var t=i(n);return function(n){return t(n instanceof c?n:new c(n))}}function f(n,t){return t?u(n)(t):u(n)}var s={};n.put=function(n,t){if(!(t instanceof Function))throw new Error("filter should be a function");s[n]=t},n.get=function(n){if(!s[n])throw new Error("filter '"+n+"' not found");return s[n]},n.map=function(t){return t.map(function(t){var e,r,o=t.match(/([^:]+):(.*)/);return o?(e=o[1].trim(),r=[o[2]]):(e=t.trim(),r=[]),function(t,o){return n.get(e).apply(null,[t].concat(r.map(function(n){return o.eval(n)})))}})};var c=function(n){if(!this)return new c(n);n instanceof Object&&this.extend(n)};c.prototype.new=function(n){var t=function(){this.extend(n)};return t.prototype=this,new t(n)},c.prototype.extend=function(n){for(var t in n)this[t]=n[t];return this},c.prototype.eval=function(n){return e(n)(this)};var a=/([^,]+)(\s*,\s*([\S]+))? in (\S+)/,l={"":function(n,t){return n.eval(t)},root:function(n,t,e,r){return e(n)},if:function(n,t,e,r){return n.eval(t)?e(n):r(n)},each:function(n,t,e,r){var o,i,u,f,s=a.exec(t.trim());if(!s)throw new Error("each expression is not correct");var c="",l=s[1],p=n.eval(s[4]),h=s[3]||(p instanceof Array?"$index":"$key");if(p instanceof Array)for(i=0,u=p.length;i<u;i++)f=n.new(),f[h]=i,f[l]=p[i],c+=e(f);else for(o in p)f=n.new(),f[h]=o,f[l]=p[o],c+=e(f);return c}},p=/\$\w*{[^}]*}|{\/}|{\:}|{else}/,h=/\$(\w*){([^}]*)}|{(\/|\:|else)}/g;f.filter=n,f.eval=e,f.scope=function(n){return new c(n)},f.cmd=function(n,t,e){t.$noContent=e,l[n]=t};var d={};return f.get=function(n){return d[n]},f.put=function(n,t){if("string"!=typeof t)throw new Error("template value should be a string");return d[n]=u(t),d[n]},f.clear=function(){for(var n in d)delete d[n];return f},f.cmd("include",function(n,t){var e=f.get(t.trim());if(!e)throw new Error("can not include template: '"+n.eval(t)+"' ( expression: "+t+" )");return e(n)},!0),f.cmd("includeEval",function(n,t){var e=f.get(n.eval(t));if(!e)throw new Error("can not include template: '"+n.eval(t)+"' ( expression: "+t+" )");return e(n)},!0),f});