!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.trisquel=t()}(this,function(){"use strict";function n(t,e){return void 0!==e&&n.put(t,e),n.get(t)}function t(n){for(var t=n.split("|"),e=[],r=t.shift();void 0!==r;)""===r?e[e.length-1]+="||"+t.shift():e.push(r),r=t.shift();return{expression:e.shift(),filters:e}}function e(e){var r=t(e),o=new Function("scope","try { with(scope) { return ("+r.expression+"); }; } catch(err) { return ''; }"),i=n.map(r.filters);return function(n){for(var t=o(n),e=0,r=i.length;e<r;e++)t=i[e](t,n);return t}}function r(n,t){return function(e){return l[n](e,t)}}function o(n,t,e,i){for(var u,c=n.shift(),s={$$content:[],$$otherwise:[]},f="$$content",a=function(){return function(n){return l[t](n,e,function(n){return s.$$content.map(function(t){return t instanceof Function?t(n):t}).join("")},function(n){return s.$$otherwise.map(function(t){return t instanceof Function?t(n):t}).join("")})}};void 0!==c;){if("string"==typeof c)s[f].push(c);else if("case"===c.cmd){if(!i)throw new Error("template root can not have cases");f=e.trim()}else if("string"==typeof c.cmd)if(c.cmd){if(!l[c.cmd])throw new Error("cmd '"+c.cmd+"' is not defined");l[c.cmd].$noContent?s[f].push(r(c.cmd,c.expression)):(u=o(n,c.cmd,c.expression,!0),s[f].push(u.fn),n=u.tokens)}else s[f].push(r(c.cmd,c.expression));else{if(":"!==c.expression&&"else"!==c.expression){if("/"===c.expression){if(!i)throw new Error("can not close root level");return{fn:a(),tokens:n}}throw new Error("'"+c.expression+"' is not a valid no-cmd expression")}f="$$otherwise"}c=n.shift()}if(i)throw new Error("cmd '"+t+"' not closed propertly");return a()}function i(n){if("string"!=typeof n)throw new Error("template should be a string");var t=0,e=n.split(p),r=[];return r[t++]=e.shift(),n.replace(h,function(n,o,i,u){if(i=u||i,o&&!l[o])throw new Error("cmd '"+o+"' is not defined");var c=e.shift();if(/\{/.test(i)){var s=i.split("{").length-i.split("}").length;if(s<0)throw new Error("curly brackets mismatch");if(s>0){var f=c.split("}");if(f.length-1<s)throw new Error("expression curly brackets mismatch");i+=f.splice(0,s).join("}")+"}",c=f.join("}")}}r[t++]={cmd:o,expression:i},r[t++]=c}),o(r,"root")}function u(n){var t=i(n);return function(n){return t(n instanceof f?n:new f(n))}}function c(n,t){return t?u(n)(t):u(n)}var s={};n.put=function(n,t){if(!(t instanceof Function))throw new Error("filter should be a function");s[n]=t},n.get=function(n){if(!s[n])throw new Error("filter '"+n+"' not found");return s[n]},n.map=function(t){return t.map(function(t){var e,r,o=t.match(/([^:]+):(.*)/);return o?(e=o[1].trim(),r=[o[2]]):(e=t.trim(),r=[]),function(t,o){return n.get(e).apply(null,[t].concat(r.map(function(n){return o.eval(n)})))}})};var f=function(n){return this?void(n instanceof Object&&this.extend(n)):new f(n)};f.prototype.new=function(n){var t=function(){this.extend(n)};return t.prototype=this,new t(n)},f.prototype.extend=function(n){for(var t in n)this[t]=n[t];return this},f.prototype.eval=function(n){return e(n)(this)};var a=/([^,]+)(\s*,\s*([\S]+))? in (\S+)/,l={"":function(n,t){return n.eval(t)},root:function(n,t,e,r){return e(n)},if:function(n,t,e,r){return n.eval(t)?e(n):r(n)},each:function(n,t,e,r){var o,i,u,c=a.exec(t.trim());if(!c)throw new Error("each expression is not correct");var s="",f=c[1],l=n.eval(c[4]),p=c[3]||(l instanceof Array?"$index":"$key");if(l instanceof Array)for(var h=0,i=l.length;h<i;h++)u=n.new(),u[p]=h,u[f]=l[h],s+=e(u);else for(var o in l)u=n.new(),u[p]=o,u[f]=l[o],s+=e(u);return s}},p=/\$\w*{[^}]*}|{\/}|{\:}|{else}/,h=/\$(\w*){([^}]*)}|{(\/|\:|else)}/g;c.filter=n,c.eval=e,c.scope=function(n){return new f(n)},c.cmd=function(n,t,e){t.$noContent=e,l[n]=t};var d={};return c.get=function(n){return d[n]},c.put=function(n,t){if("string"!=typeof t)throw new Error("template value should be a string");return d[n]=u(t),d[n]},c.clear=function(){for(var n in d)delete d[n];return c},c.cmd("include",function(n,t){var e=c.get(t.trim());if(!e)throw new Error("can not include template: '"+n.eval(t)+"' ( expression: "+t+" )");return e(n)},!0),c.cmd("includeEval",function(n,t){var e=c.get(n.eval(t));if(!e)throw new Error("can not include template: '"+n.eval(t)+"' ( expression: "+t+" )");return e(n)},!0),c});