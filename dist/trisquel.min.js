!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.trisquel=e()}(this,function(){"use strict";function t(t,e,n){for(var r=0,i=t.length;r<i;r++)e=t[r](e,n);return e}function e(t,e){return e.map(function(e){var n,r,i=e.match(/([^:]+):(.*)/);return i?(n=i[1].trim(),r=[i[2]]):(n=e.trim(),r=[]),function(e,i){if(!t[n])throw new Error("filter '"+n+"' is not defined");return t[n].apply(i,[e].concat(r.map(function(t){return i.eval(t)})))}})}function n(t){return t.trim()}function r(t){for(var e=t.split("|"),r=[],i=e.shift();void 0!==i;)""===i?r[r.length-1]+="||"+e.shift():r.push(i),i=e.shift();return{expression:r.shift(),filters:r.map(n)}}function i(n,i,o){var s,c=r(n),f=i?e(i,c.filters):[];return o&&(c.expression=c.expression.trim()),function(e,n){return n||s||(s=new Function("scope","try { with(scope) { return ("+c.expression+"); }; } catch(err) { return ''; }")),t(f,n?n.call(e,c.expression,e):s(e),e)}}function o(t){return this instanceof o?void(t instanceof Object&&this.extend(t)):new o(t)}function s(t,e,n,r,i){for(var c=e.shift(),f={$$content:[],$$otherwise:[]},u="$$content",h=t.cmds,a=function(e,n,r){return function(i){return e[n].call(t,i instanceof o?i:new o(i),r)}},l=function(e){return h[n].call(t,e instanceof o?e:new o(e),r,function(t){return f.$$content.map(function(e){return e instanceof Function?e(t):e}).join("")},function(t){return f.$$otherwise.map(function(e){return e instanceof Function?e(t):e}).join("")})};void 0!==c;){if("string"==typeof c)f[u].push(c);else if("string"==typeof c.cmd)if(c.cmd){if(!h[c.cmd])throw new Error("cmd '"+c.cmd+"' is not defined");h[c.cmd].$no_content?f[u].push(a(h,c.cmd,c.expression)):f[u].push(s(t,e,c.cmd,c.expression,!0))}else f[u].push(a(h,c.cmd,c.expression));else{if(":"!==c.expression&&"else"!==c.expression){if("/"===c.expression){if(!i)throw new Error("can not close root level");return l}throw new Error("'"+c.expression+"' is not a valid no-cmd expression")}u="$$otherwise"}c=e.shift()}if(i)throw new Error("cmd '"+n+"' not closed propertly");return l}function c(t){if("string"!=typeof t)throw new TypeError("template should be a string");var e=0,n=t.split(a),r=[],i=this.cmds;return r[e++]=n.shift(),t.replace(l,function(t,o,s,c){if(s=c||s,o&&!i[o])throw new Error("cmd '"+o+"' is not defined");var f=n.shift();if(/\{/.test(s)){var u=s.split("{").length-s.split("}").length;if(u<0)throw new Error("curly brackets mismatch");if(u>0){for(var h=f.split("}");u>0;){if(h.length-1<u)throw new Error("expression curly brackets mismatch");s+=h.splice(0,u).join("}")+"}",u=s.split("{").length-s.split("}").length}f=h.join("}")}}r[e++]={cmd:o,expression:s},r[e++]=f}),s(this,r,"root")}function f(t,e){return e?c.call(this,t)(e):c.call(this,t)}function u(t,e){return f.call(u,t,e)}function h(t){t||void 0===t?(this.cmds=Object.create(u.cmds),this.filters=Object.create(u.filters),this.cache=Object.create(u.cache)):(this.cmds=Object.create(d),this.filters={},this.cache={})}o.prototype.new=function(t){var e=Object.create(this);return t instanceof Object&&e.extend(t),e},o.prototype.extend=function(t){for(var e in t)this[e]=t[e];return this},o.prototype.eval=function(t){return i(t)(this)};var a=/\$\w*{[^}]*}|{\/}|{:}|{else}/,l=/\$(\w*){([^}]*)}|{(\/|:|else)}/g,p=/([^,]+)(\s*,\s*([\S]+))? in (\S+)/,d={"":function(t,e){return this.eval(e,t)},root:function(t,e,n,r){return n(t)},if:function(t,e,n,r){return this.eval(e,t)?n(t):r(t)},each:function(t,e,n,r){var i,o,s,c,f=p.exec(e.trim());if(!f)throw new Error("each expression is not correct");var u="",h=f[1],a=this.eval(f[4],t),l=f[3]||(a instanceof Array?"$index":"$key");if(a instanceof Array)for(o=0,s=a.length;o<s;o++)c=t.new(),c[l]=o,c[h]=a[o],u+=n(c);else for(i in a)c=t.new(),c[l]=i,c[h]=a[i],u+=n(c);return u}};u.cmds=Object.create(d),u.filters={},u.cache={},u.scope=o,u.Scope=o,u.Trisquel=h;var m={compile:f,eval:function(t,e,n,r){return e?i(t,this.filters,r)(e,n):i(t,this.filters)},filter:function(t,e){return void 0===e?this.filters[t]:void(this.filters[t]=e)},cmd:function(t,e,n){e.$no_content=n,this.cmds[t]=e},get:function(t){return this.cache[t]},put:function(t,e){return this.cache[t]=this.compile(e),this.cache[t]},clear:function(){for(var t in this.cache)delete this.cache[t]}};for(var v in m)u[v]=m[v],h.prototype[v]=m[v];return u.cmd("include",function(t,e){var n=this.get(e.trim());if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),u.cmd("includeEval",function(t,e){var n=this.get(this.eval(e,t));if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),u});