!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.trisquel=e()}(this,function(){"use strict";function t(t){for(var e=t.split("|"),n=[],r=e.shift();void 0!==r;)""===r?n[n.length-1]+="||"+e.shift():n.push(r),r=e.shift();return{expression:n.shift(),filters:n}}function e(t,e){return e.map(function(e){var n,r,i=e.match(/([^:]+):(.*)/);return i?(n=i[1].trim(),r=[i[2]]):(n=e.trim(),r=[]),function(e,i){if(!t[n])throw new Error("filter '"+n+"' is not defined");return t[n].apply(i,[e].concat(r.map(function(t){return i.eval(t)})))}})}function n(n,r){var i=t(n),o=new Function("scope","try { with(scope) { return ("+i.expression+"); }; } catch(err) { return ''; }"),c=r?e(r,i.filters):[];return function(t){for(var e=o(t),n=0,r=c.length;n<r;n++)e=c[n](e,t);return e}}function r(t){if(!(this instanceof r))return new r(t);t instanceof Object&&this.extend(t)}function i(t,e,n,o,c){for(var s=e.shift(),f={$$content:[],$$otherwise:[]},u="$$content",h=t.cmds,a=function(e,n,i){return function(o){return e[n].call(t,o instanceof r?o:new r(o),i)}},l=function(e){return h[n].call(t,e instanceof r?e:new r(e),o,function(t){return f.$$content.map(function(e){return e instanceof Function?e(t):e}).join("")},function(t){return f.$$otherwise.map(function(e){return e instanceof Function?e(t):e}).join("")})};void 0!==s;){if("string"==typeof s)f[u].push(s);else if("string"==typeof s.cmd)if(s.cmd){if(!h[s.cmd])throw new Error("cmd '"+s.cmd+"' is not defined");h[s.cmd].$no_content?f[u].push(a(h,s.cmd,s.expression)):f[u].push(i(t,e,s.cmd,s.expression,!0))}else f[u].push(a(h,s.cmd,s.expression));else{if(":"!==s.expression&&"else"!==s.expression){if("/"===s.expression){if(!c)throw new Error("can not close root level");return l}throw new Error("'"+s.expression+"' is not a valid no-cmd expression")}u="$$otherwise"}s=e.shift()}if(c)throw new Error("cmd '"+n+"' not closed propertly");return l}function o(t){if("string"!=typeof t)throw new TypeError("template should be a string");var e=0,n=t.split(u),r=[],o=this.cmds;return r[e++]=n.shift(),t.replace(h,function(t,i,c,s){if(c=s||c,i&&!o[i])throw new Error("cmd '"+i+"' is not defined");var f=n.shift();if(/\{/.test(c)){var u=c.split("{").length-c.split("}").length;if(u<0)throw new Error("curly brackets mismatch");if(u>0){for(var h=f.split("}");u>0;){if(h.length-1<u)throw new Error("expression curly brackets mismatch");c+=h.splice(0,u).join("}")+"}",u=c.split("{").length-c.split("}").length}f=h.join("}")}}r[e++]={cmd:i,expression:c},r[e++]=f}),i(this,r,"root")}function c(t,e){return e?o.call(this,t)(e):o.call(this,t)}function s(t,e){return c.call(s,t,e)}function f(t){t||void 0===t?(this.cmds=Object.create(s.cmds),this.filters=Object.create(s.filters),this.cache=Object.create(s.cache)):(this.cmds=Object.create(l),this.filters={},this.cache={})}r.prototype.new=function(t){var e=Object.create(this);return t instanceof Object&&e.extend(t),e},r.prototype.extend=function(t){for(var e in t)this[e]=t[e];return this},r.prototype.eval=function(t){return n(t)(this)};var u=/\$\w*{[^}]*}|{\/}|{:}|{else}/,h=/\$(\w*){([^}]*)}|{(\/|:|else)}/g,a=/([^,]+)(\s*,\s*([\S]+))? in (\S+)/,l={"":function(t,e){return this.eval(e,t)},root:function(t,e,n,r){return n(t)},if:function(t,e,n,r){return this.eval(e,t)?n(t):r(t)},each:function(t,e,n,r){var i,o,c,s,f=a.exec(e.trim());if(!f)throw new Error("each expression is not correct");var u="",h=f[1],l=this.eval(f[4],t),p=f[3]||(l instanceof Array?"$index":"$key");if(l instanceof Array)for(o=0,c=l.length;o<c;o++)s=t.new(),s[p]=o,s[h]=l[o],u+=n(s);else for(i in l)s=t.new(),s[p]=i,s[h]=l[i],u+=n(s);return u}};s.cmds=Object.create(l),s.filters={},s.cache={},s.scope=r,s.Scope=r,s.Template=f;var p={compile:c,eval:function(t,e){return n(t,this.filters)(e)},filter:function(t,e){if(void 0===e)return this.filters[t];this.filters[t]=e},cmd:function(t,e,n){e.$no_content=n,this.cmds[t]=e},get:function(t){return this.cache[t]},put:function(t,e){return this.cache[t]=this.compile(e),this.cache[t]},clear:function(){for(var t in this.cache)delete this.cache[t]}};for(var d in p)s[d]=p[d],f.prototype[d]=p[d];return s.cmd("include",function(t,e){var n=this.get(e.trim());if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),s.cmd("includeEval",function(t,e){var n=this.get(this.eval(e,t));if(!n)throw new Error("can not include template: '"+this.eval(e,t)+"' ( expression: "+e+" )");return n(t)},!0),s});
